<!-- Contributors:
 - Mahmoud
-->
{% extends 'admin_panel/base.html' %}

{% block title %}Model Details{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h1>Model Details</h1>
    <div>
        <a href="{% url 'admin_panel:models_list' %}" class="btn btn-secondary">Back to Models</a>
        {% if not model.is_active %}
        <a href="{% url 'admin_panel:deploy_model' model.id %}" class="btn btn-success">Activate This Model</a>
        <form action="{% url 'admin_panel:delete_model' model.id %}" method="post"
            style="display: inline-block; margin-left: 0.5rem;"
            onsubmit="return confirm('Are you sure you want to delete this model? This cannot be undone.');">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger"
                style="background-color: #dc3545; border-color: #dc3545; color: white;">Delete Model</button>
        </form>
        {% endif %}
    </div>
</div>

<div class="card">
    <h2>Model Information</h2>
    <table>
        <tr>
            <th style="width: 30%;">Version ID</th>
            <td><strong>{{ model.version_id }}</strong></td>
        </tr>
        <tr>
            <th>Status</th>
            <td>
                {% if model.is_active %}
                <span class="badge badge-success">Active</span>
                {% else %}
                <span class="badge badge-secondary">Available</span>
                {% endif %}
            </td>
        </tr>
        <tr>
            <th>Model File</th>
            <td>{{ model.model_file }}</td>
        </tr>
        <tr>
            <th>Framework</th>
            <td>{{ model.framework }}</td>
        </tr>
        <tr>
            <th>Training Date</th>
            <td>{{ model.training_date|date:"Y-m-d H:i:s" }}</td>
        </tr>
        <tr>
            <th>Trained By</th>
            <td>{{ model.trained_by.username|default:"System" }}</td>
        </tr>
        {% if model.is_active %}
        <tr>
            <th>Activated Date</th>
            <td>{{ model.deployment_date|date:"Y-m-d H:i:s" }}</td>
        </tr>
        <tr>
            <th>Activated By</th>
            <td>{{ model.deployed_by.username|default:"System" }}</td>
        </tr>
        {% endif %}
    </table>
</div>

<div class="card">
    <h2>Performance Metrics</h2>
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Test Accuracy</h3>
            <div class="value">{{ model.test_accuracy|floatformat:2 }}%</div>
        </div>
        <div class="stat-card">
            <h3>Validation Accuracy</h3>
            <div class="value">{{ model.validation_accuracy|floatformat:2|default:"N/A" }}%</div>
        </div>
        <div class="stat-card">
            <h3>Training Accuracy</h3>
            <div class="value">{{ model.train_accuracy|floatformat:2|default:"N/A" }}%</div>
        </div>
        <div class="stat-card">
            <h3>Predictions Made</h3>
            <div class="value">{{ prediction_count }}</div>
            <div class="change">Avg Confidence: {{ avg_confidence|floatformat:1 }}%</div>
        </div>
    </div>
</div>

<div class="card">
    <h2>Evaluation Metrics</h2>
    <div class="stats-grid" style="grid-template-columns: 1fr 1fr; align-items: start;">
        <div class="stat-card confusion-matrix">
            <div class="value" style="text-align: center;">
                <img src="data:image/png;base64,{{ cm_image }}" alt="Confusion Matrix" />
            </div>
        </div>
        <div style="display: flex; flex-direction: column; gap: 1rem;">
            <div class="stat-card">
                <h3>Test Precision</h3>
                <div class="value">{{ model.test_precision|floatformat:2 }}%</div>
            </div>
            <div class="stat-card">
                <h3>Test Recall</h3>
                <div class="value">{{ model.test_recall|floatformat:2 }}%</div>
            </div>
            <div class="stat-card">
                <h3>Test F1 Score</h3>
                <div class="value">{{ model.test_f1_score|floatformat:2 }}%</div>
            </div>
        </div>
    </div>
</div>

<div class="card">
    <h2>Training Configuration</h2>
    <table>
        <tr>
            <th style="width: 30%;">Epochs</th>
            <td>{{ model.epochs }}</td>
        </tr>
        <tr>
            <th>Batch Size</th>
            <td>{{ model.batch_size }}</td>
        </tr>
        <tr>
            <th>Learning Rate</th>
            <td>{{ model.learning_rate|default:"N/A" }}</td>
        </tr>

        <tr>
            <th>Training Dataset Size</th>
            <td>{{ model.train_dataset_size }} samples</td>
        </tr>
        <tr>
            <th>Test Dataset Size</th>
            <td>{{ model.test_dataset_size|default:"N/A" }} samples</td>
        </tr>
        <tr>
            <th>Validation Dataset Size</th>
            <td>{{ model.validation_dataset_size|default:"N/A" }} samples</td>
        </tr>
    </table>
</div>

{% if class_dist %}
<div class="card">
    <h2>Prediction Distribution by Class</h2>
    <table>
        <thead>
            <tr>
                <th>Gesture Class</th>
                <th>Predictions</th>
                <th>Percentage</th>
            </tr>
        </thead>
        <tbody>
            {% for item in class_dist %}
            <tr>
                <td><strong>{{ item.predicted_class }}</strong></td>
                <td>{{ item.count }}</td>
                <td>{{ item.percentage }}%</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}

{% if model.description %}
<div class="card">
    <h2>Description</h2>
    <p>{{ model.description }}</p>
</div>
{% endif %}

{% if model.notes %}
<div class="card">
    <h2>Notes</h2>
    <pre style="white-space: pre-wrap;">{{ model.notes }}</pre>
</div>
{% endif %}

<div class="card">
    <h2>Recent Predictions</h2>
    {% if predictions %}
    <table>
        <thead>
            <tr>
                <th>Time</th>
                <th>Predicted Class</th>
                <th>Confidence</th>
                <th>Inference Time</th>
            </tr>
        </thead>
        <tbody>
            {% for pred in predictions|slice:":20" %}
            <tr>
                <td>{{ pred.created_at|date:"Y-m-d H:i:s" }}</td>
                <td><strong>{{ pred.predicted_class }}</strong></td>
                <td>{{ pred.confidence|floatformat:1 }}%</td>
                <td>{{ pred.inference_time_ms|floatformat:1|default:"N/A" }} ms</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p>No predictions yet with this model.</p>
    {% endif %}
</div>
{% endblock %}