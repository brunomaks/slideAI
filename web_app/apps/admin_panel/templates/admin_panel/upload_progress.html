{% extends 'admin_panel/base.html' %}

{% block title %}Upload Progress{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">Dataset Upload Progress</h1>

<div class="card">
    <h2>{{ upload_task.filename }}</h2>

    <div style="margin-top: 2rem;">
        <div
            style="background: rgba(0,0,0,0.3); border-radius: 8px; overflow: hidden; height: 40px; position: relative;">
            <div id="progress-bar" style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                height: 100%;
                width: {{ upload_task.progress_percentage }}%;
                transition: width 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-weight: bold;
            ">
                <span id="progress-text">{{ upload_task.progress_percentage }}%</span>
            </div>
        </div>
    </div>

    <div
        style="margin-top: 2rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 4px;">
            <div style="color: #888; font-size: 0.9rem;">Status</div>
            <div id="status"
                style="font-size: 1.2rem; font-weight: bold; margin-top: 0.5rem; text-transform: capitalize;">
                {{ upload_task.status }}
            </div>
        </div>

        <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 4px;">
            <div style="color: #888; font-size: 0.9rem;">Files Processed</div>
            <div id="files-processed" style="font-size: 1.2rem; font-weight: bold; margin-top: 0.5rem;">
                <span id="processed">{{ upload_task.processed_files }}</span> / <span id="total">{{
                    upload_task.total_files }}</span>
            </div>
        </div>

        <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 4px;">
            <div style="color: #888; font-size: 0.9rem;">Train Images</div>
            <div id="train-count" style="font-size: 1.2rem; font-weight: bold; margin-top: 0.5rem; color: #667eea;">
                {{ upload_task.train_count }}
            </div>
        </div>

        <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 4px;">
            <div style="color: #888; font-size: 0.9rem;">Test Images</div>
            <div id="test-count" style="font-size: 1.2rem; font-weight: bold; margin-top: 0.5rem; color: #764ba2;">
                {{ upload_task.test_count }}
            </div>
        </div>
    </div>

    <div id="error-message"
        style="display: none; margin-top: 2rem; padding: 1rem; background: rgba(255,0,0,0.1); border-left: 4px solid #ff4444; border-radius: 4px;">
        <strong>Error:</strong> <span id="error-text"></span>
    </div>

    <div id="completion-message"
        style="display: none; margin-top: 2rem; padding: 1rem; background: rgba(0,255,0,0.1); border-left: 4px solid #44ff44; border-radius: 4px;">
        <strong>âœ“ Upload completed successfully!</strong>
        <br>
        <a href="{% url 'admin_panel:view_dataset' %}" class="btn btn-primary"
            style="margin-top: 1rem; display: inline-block;">View Images</a>
    </div>
</div>

<script>
    let pollInterval;
    const taskId = "{{ upload_task.task_id }}";
    const apiUrl = "{% url 'admin_panel:upload_progress_api' task_id=upload_task.task_id %}";

    function updateProgress() {
        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                // Update progress bar
                const progressBar = document.getElementById('progress-bar');
                const progressText = document.getElementById('progress-text');
                progressBar.style.width = data.progress + '%';
                progressText.textContent = data.progress + '%';

                // Update stats
                document.getElementById('status').textContent = data.status;
                document.getElementById('processed').textContent = data.processed_files;
                document.getElementById('total').textContent = data.total_files;
                document.getElementById('train-count').textContent = data.train_count;
                document.getElementById('test-count').textContent = data.test_count;

                // Check completion
                if (data.status === 'completed') {
                    clearInterval(pollInterval);
                    document.getElementById('completion-message').style.display = 'block';
                } else if (data.status === 'failed') {
                    clearInterval(pollInterval);
                    document.getElementById('error-message').style.display = 'block';
                    document.getElementById('error-text').textContent = data.error_message;
                }
            })
            .catch(error => {
                console.error('Error polling progress:', error);
            });
    }

    // Poll every 500ms
    pollInterval = setInterval(updateProgress, 500);

    // Initial update
    updateProgress();

    // Cleanup on page unload
    window.addEventListener('beforeunload', () => {
        if (pollInterval) {
            clearInterval(pollInterval);
        }
    });
</script>

{% endblock %}